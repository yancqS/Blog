<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Babel 插件手册 | Yoha&#39;s Blog</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/blog/favicon.ico">
    <meta name="description" content="文档涵盖了如何创建 Babel 插件等方面的内容">
    
    <link rel="preload" href="/blog/assets/css/0.styles.75eee9cd.css" as="style"><link rel="preload" href="/blog/assets/js/app.b3165492.js" as="script"><link rel="preload" href="/blog/assets/js/7.e383f68a.js" as="script"><link rel="preload" href="/blog/assets/js/16.2c89c2bd.js" as="script"><link rel="preload" href="/blog/assets/js/6.00881a70.js" as="script"><link rel="prefetch" href="/blog/assets/js/1.fc7e7234.js"><link rel="prefetch" href="/blog/assets/js/10.beaac110.js"><link rel="prefetch" href="/blog/assets/js/11.aa35d1aa.js"><link rel="prefetch" href="/blog/assets/js/12.a86548b5.js"><link rel="prefetch" href="/blog/assets/js/13.a714a451.js"><link rel="prefetch" href="/blog/assets/js/14.e2694484.js"><link rel="prefetch" href="/blog/assets/js/15.4d7d14e9.js"><link rel="prefetch" href="/blog/assets/js/17.dfa654ae.js"><link rel="prefetch" href="/blog/assets/js/18.e3c69faa.js"><link rel="prefetch" href="/blog/assets/js/19.13e9e275.js"><link rel="prefetch" href="/blog/assets/js/20.a489ac9f.js"><link rel="prefetch" href="/blog/assets/js/21.7ee31177.js"><link rel="prefetch" href="/blog/assets/js/22.5e128952.js"><link rel="prefetch" href="/blog/assets/js/23.b98f93b3.js"><link rel="prefetch" href="/blog/assets/js/24.4865e746.js"><link rel="prefetch" href="/blog/assets/js/25.57c1aaec.js"><link rel="prefetch" href="/blog/assets/js/26.51135953.js"><link rel="prefetch" href="/blog/assets/js/27.bd70986a.js"><link rel="prefetch" href="/blog/assets/js/28.6330717e.js"><link rel="prefetch" href="/blog/assets/js/29.46e29204.js"><link rel="prefetch" href="/blog/assets/js/30.880634cb.js"><link rel="prefetch" href="/blog/assets/js/31.73d81b97.js"><link rel="prefetch" href="/blog/assets/js/32.3d26ad82.js"><link rel="prefetch" href="/blog/assets/js/33.2d10efdf.js"><link rel="prefetch" href="/blog/assets/js/34.e4dbc964.js"><link rel="prefetch" href="/blog/assets/js/35.782422e8.js"><link rel="prefetch" href="/blog/assets/js/36.21c1a3ed.js"><link rel="prefetch" href="/blog/assets/js/37.83e99a50.js"><link rel="prefetch" href="/blog/assets/js/38.94bc9bde.js"><link rel="prefetch" href="/blog/assets/js/39.b724a208.js"><link rel="prefetch" href="/blog/assets/js/4.b92d0852.js"><link rel="prefetch" href="/blog/assets/js/40.415a8f85.js"><link rel="prefetch" href="/blog/assets/js/41.da012701.js"><link rel="prefetch" href="/blog/assets/js/42.aeaf70d4.js"><link rel="prefetch" href="/blog/assets/js/43.b39484a1.js"><link rel="prefetch" href="/blog/assets/js/44.3895a307.js"><link rel="prefetch" href="/blog/assets/js/45.e719e4ef.js"><link rel="prefetch" href="/blog/assets/js/46.e1c3528a.js"><link rel="prefetch" href="/blog/assets/js/47.778f8083.js"><link rel="prefetch" href="/blog/assets/js/48.8cd62c88.js"><link rel="prefetch" href="/blog/assets/js/49.414e8211.js"><link rel="prefetch" href="/blog/assets/js/5.fb57028e.js"><link rel="prefetch" href="/blog/assets/js/50.3ecff4cd.js"><link rel="prefetch" href="/blog/assets/js/51.a854dc36.js"><link rel="prefetch" href="/blog/assets/js/52.d5b5b482.js"><link rel="prefetch" href="/blog/assets/js/53.58d0333b.js"><link rel="prefetch" href="/blog/assets/js/54.23d34163.js"><link rel="prefetch" href="/blog/assets/js/55.beae23ea.js"><link rel="prefetch" href="/blog/assets/js/56.82368ebc.js"><link rel="prefetch" href="/blog/assets/js/57.17524f2b.js"><link rel="prefetch" href="/blog/assets/js/58.63e9acf2.js"><link rel="prefetch" href="/blog/assets/js/59.aaacc01a.js"><link rel="prefetch" href="/blog/assets/js/60.9bc94671.js"><link rel="prefetch" href="/blog/assets/js/61.b5660afd.js"><link rel="prefetch" href="/blog/assets/js/62.473a036e.js"><link rel="prefetch" href="/blog/assets/js/63.5a23c590.js"><link rel="prefetch" href="/blog/assets/js/64.7c7a9c0d.js"><link rel="prefetch" href="/blog/assets/js/65.8cc5fff2.js"><link rel="prefetch" href="/blog/assets/js/66.174fbb03.js"><link rel="prefetch" href="/blog/assets/js/67.421e6d8f.js"><link rel="prefetch" href="/blog/assets/js/68.b8d6aab8.js"><link rel="prefetch" href="/blog/assets/js/69.1a8445d5.js"><link rel="prefetch" href="/blog/assets/js/70.5212a673.js"><link rel="prefetch" href="/blog/assets/js/71.02a46480.js"><link rel="prefetch" href="/blog/assets/js/72.de7cb2e7.js"><link rel="prefetch" href="/blog/assets/js/73.b3882d06.js"><link rel="prefetch" href="/blog/assets/js/74.4779b4b7.js"><link rel="prefetch" href="/blog/assets/js/75.03960c98.js"><link rel="prefetch" href="/blog/assets/js/76.4d9878cc.js"><link rel="prefetch" href="/blog/assets/js/77.251bd2e1.js"><link rel="prefetch" href="/blog/assets/js/78.a593d24c.js"><link rel="prefetch" href="/blog/assets/js/79.597b96f8.js"><link rel="prefetch" href="/blog/assets/js/8.69cb0bf8.js"><link rel="prefetch" href="/blog/assets/js/80.1b87ebdf.js"><link rel="prefetch" href="/blog/assets/js/81.324d625f.js"><link rel="prefetch" href="/blog/assets/js/82.698ba1a4.js"><link rel="prefetch" href="/blog/assets/js/83.d85c8a47.js"><link rel="prefetch" href="/blog/assets/js/84.805f8114.js"><link rel="prefetch" href="/blog/assets/js/85.12f3ef2c.js"><link rel="prefetch" href="/blog/assets/js/86.40555757.js"><link rel="prefetch" href="/blog/assets/js/9.7afd78bb.js"><link rel="prefetch" href="/blog/assets/js/vuejs-paginate.f8807e9a.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.75eee9cd.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="global-layout d-flex flex-column"><header id="header" class="shadow"><nav class="p-3 d-flex desktop-menu justify-content-between"><div class="d-flex blog-info-wrapper"><a href="/blog/" class="text-decoration-none m-0 router-link-active"><div class="card-img-bg d-inline-block blog-logo"><img src="https://gitee.com/yancqS/blogImage/raw/master/blogImage/20210414163022.jpeg" height="40px" style="margin-right:10px;"></div></a> <a href="/blog/" class="blog-title router-link-active"><div class="h4 text-center">
          Yoha's Blog
        </div></a></div> <ul role="menubar" class="d-flex justify-content-center border-0 el-menu--horizontal el-menu" style="background-color:;"><li role="menuitem" tabindex="-1" router="" class="el-menu-item" style="color:;border-bottom-color:transparent;background-color:;"><i class="el-icon-house"></i>
    Home
  </li><li role="menuitem" tabindex="-1" router="" class="el-menu-item" style="color:;border-bottom-color:transparent;background-color:;"><i class="el-icon-lollipop"></i>
    Life
  </li><li role="menuitem" tabindex="-1" router="" class="el-menu-item" style="color:;border-bottom-color:transparent;background-color:;"><i class="el-icon-s-management"></i>
    Handbook
  </li><li role="menuitem" tabindex="-1" router="" class="el-menu-item" style="color:;border-bottom-color:transparent;background-color:;"><span>💕</span>
    Emoji
  </li></ul> <div class="search-wrapper u-px3 d-flex align-items-center"><div aria-haspopup="listbox" role="combobox" aria-owns="el-autocomplete-6063" class="el-autocomplete"><div class="el-input el-input--small"><!----><input type="text" autocomplete="off" valueKey="value" popperClass="components-search" placeholder="Search" fetchSuggestions="function () { [native code] }" debounce="200" placement="bottom-end" popperAppendToBody="true" class="el-input__inner"><!----><!----><!----><!----></div><div role="region" class="el-autocomplete-suggestion el-popper components-search" style="width:;display:none;"><div class="el-scrollbar"><div class="el-autocomplete-suggestion__wrap el-scrollbar__wrap el-scrollbar__wrap--hidden-default"><ul class="el-scrollbar__view el-autocomplete-suggestion__list"></ul></div><div class="el-scrollbar__bar is-horizontal"><div class="el-scrollbar__thumb" style="width:0;transform:translateX(0%);ms-transform:translateX(0%);webkit-transform:translateX(0%);"></div></div><div class="el-scrollbar__bar is-vertical"><div class="el-scrollbar__thumb" style="height:0;transform:translateY(0%);ms-transform:translateY(0%);webkit-transform:translateY(0%);"></div></div></div></div></div></div> <div id="toggle"><div id="top" class="span"></div> <div id="middle" class="span"></div> <div id="bottom" class="span"></div></div></nav> <div class="flex-column align-items-center mobile-menu pb-4"><ul role="menubar" class="d-flex justify-content-center border-0 el-menu--horizontal el-menu" style="background-color:;"><li role="menuitem" tabindex="-1" router="" class="el-menu-item" style="color:;border-bottom-color:transparent;background-color:;"><i class="el-icon-house"></i>
    Home
  </li><li role="menuitem" tabindex="-1" router="" class="el-menu-item" style="color:;border-bottom-color:transparent;background-color:;"><i class="el-icon-lollipop"></i>
    Life
  </li><li role="menuitem" tabindex="-1" router="" class="el-menu-item" style="color:;border-bottom-color:transparent;background-color:;"><i class="el-icon-s-management"></i>
    Handbook
  </li><li role="menuitem" tabindex="-1" router="" class="el-menu-item" style="color:;border-bottom-color:transparent;background-color:;"><span>💕</span>
    Emoji
  </li></ul> <div class="search-wrapper u-px3 d-flex align-items-center pt-4"><div aria-haspopup="listbox" role="combobox" aria-owns="el-autocomplete-925" class="el-autocomplete"><div class="el-input el-input--small"><!----><input type="text" autocomplete="off" valueKey="value" popperClass="components-search" placeholder="Search" fetchSuggestions="function () { [native code] }" debounce="200" placement="bottom-end" popperAppendToBody="true" class="el-input__inner"><!----><!----><!----><!----></div><div role="region" class="el-autocomplete-suggestion el-popper components-search" style="width:;display:none;"><div class="el-scrollbar"><div class="el-autocomplete-suggestion__wrap el-scrollbar__wrap el-scrollbar__wrap--hidden-default"><ul class="el-scrollbar__view el-autocomplete-suggestion__list"></ul></div><div class="el-scrollbar__bar is-horizontal"><div class="el-scrollbar__thumb" style="width:0;transform:translateX(0%);ms-transform:translateX(0%);webkit-transform:translateX(0%);"></div></div><div class="el-scrollbar__bar is-vertical"><div class="el-scrollbar__thumb" style="height:0;transform:translateY(0%);ms-transform:translateY(0%);webkit-transform:translateY(0%);"></div></div></div></div></div></div></div></header> <div id="vuperess-theme-blog__post-layout" data-v-5392b086><main class="vuepress-blog-theme-content" data-v-5392b086><div class="el-card my-4 is-always-shadow" data-v-5392b086><!----><div class="el-card__body" style="padding:1rem 2rem;"><div data-v-5392b086><h1 class="text-center text-capitalize" data-v-5392b086>
          Babel 插件手册
        </h1> <hr data-v-5392b086> <p class="text-secondary" data-v-5392b086>
          文档涵盖了如何创建 Babel 插件等方面的内容
        </p> <ul class="languages-list" data-v-5392b086><li data-v-5392b086>
            AST
          </li><li data-v-5392b086>
            Babel
          </li></ul></div></div></div> <div class="el-card is-always-shadow" data-v-5392b086><!----><div class="el-card__body" style="padding:1rem 2rem;"><div class="content__default" data-v-5392b086><h1 id="babel-插件手册"><a href="#babel-插件手册" class="header-anchor">#</a> Babel 插件手册</h1> <p>这篇文档涵盖了如何创建 <a href="https://babeljs.io" target="_blank" rel="noopener noreferrer">Babel<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <a href="https://babeljs.io/docs/advanced/plugins/" target="_blank" rel="noopener noreferrer">插件<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>等方面的内容。.</p> <p><a href="http://creativecommons.org/licenses/by/4.0/" target="_blank" rel="noopener noreferrer"><img src="https://licensebuttons.net/l/by/4.0/80x15.png" alt="cc-by-4.0"><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h1 id="目录"><a href="#目录" class="header-anchor">#</a> 目录</h1> <ul><li><a href="#toc-introduction">介绍</a></li> <li><a href="#toc-basics">基础</a> <ul><li><a href="#toc-asts">抽象语法树（ASTs）</a></li> <li><a href="#toc-stages-of-babel">Babel 的处理步骤</a></li> <li><a href="#toc-parse">解析</a> <ul><li><a href="#toc-lexical-analysis">词法分析</a></li> <li><a href="#toc-syntactic-analysis">语法分析</a></li></ul></li> <li><a href="#toc-transform">转换</a></li> <li><a href="#toc-generate">生成</a></li> <li><a href="#toc-traversal">遍历</a></li> <li><a href="#toc-visitors">Visitors（访问者）</a></li> <li><a href="#toc-paths">Paths（路径）</a> <ul><li><a href="#toc-paths-in-visitors">Paths in Visitors（存在于访问者中的路径）</a></li></ul></li> <li><a href="#toc-state">State（状态）</a></li> <li><a href="#toc-scopes">Scopes（作用域）</a> <ul><li><a href="#toc-bindings">Bindings（绑定）</a></li></ul></li></ul></li> <li><a href="#toc-api">API</a> <ul><li><a href="#toc-babylon">babylon</a></li> <li><a href="#toc-babel-traverse">babel-traverse</a></li> <li><a href="#toc-babel-types">babel-types</a></li> <li><a href="#toc-definitions">Definitions（定义）</a></li> <li><a href="#toc-builders">Builders（构建器）</a></li> <li><a href="#toc-validators">Validators（验证器）</a></li> <li><a href="#toc-converters">Converters（变换器）</a></li> <li><a href="#toc-babel-generator">babel-generator</a></li> <li><a href="#toc-babel-template">babel-template</a></li></ul></li> <li><a href="#toc-writing-your-first-babel-plugin">编写你的第一个 Babel 插件</a></li> <li><a href="#toc-transformation-operations">转换操作</a> <ul><li><a href="#toc-visiting">访问</a></li> <li><a href="#toc-get-the-path-of-a-sub-node">获取子节点的Path</a></li> <li><a href="#toc-check-if-a-node-is-a-certain-type">检查节点（Node）类型</a></li> <li><a href="#toc-check-if-a-path-is-a-certain-type">检查路径（Path）类型</a></li> <li><a href="#toc-check-if-an-identifier-is-referenced">检查标识符（Identifier）是否被引用</a></li> <li><a href="#toc-find-a-specific-parent-path">找到特定的父路径</a></li> <li><a href="#toc-get-sibling-paths">获取同级路径</a></li> <li><a href="#toc-stopping-traversal">停止遍历</a></li> <li><a href="#toc-manipulation">处理</a></li> <li><a href="#toc-replacing-a-node">替换一个节点</a></li> <li><a href="#toc-replacing-a-node-with-multiple-nodes">用多节点替换单节点</a></li> <li><a href="#toc-replacing-a-node-with-a-source-string">用字符串源码替换节点</a></li> <li><a href="#toc-inserting-a-sibling-node">插入兄弟节点</a></li> <li><a href="#toc-inserting-into-a-container">插入到容器（container）中</a></li> <li><a href="#toc-removing-a-node">删除节点</a></li> <li><a href="#toc-replacing-a-parent">替换父节点</a></li> <li><a href="#toc-removing-a-parent">删除父节点</a></li> <li><a href="#toc-scope">Scope（作用域）</a></li> <li><a href="#toc-checking-if-a-local-variable-is-bound">检查本地变量是否被绑定</a></li> <li><a href="#toc-generating-a-uid">生成UID</a></li> <li><a href="#toc-pushing-a-variable-declaration-to-a-parent-scope">提升变量声明至父级作用域</a></li> <li><a href="#toc-rename-a-binding-and-its-references">重命名绑定及其引用</a></li></ul></li> <li><a href="#toc-plugin-options">插件选项</a> <ul><li><a href="#toc-pre-and-post-in-plugins">插件的准备和收尾工作</a></li> <li><a href="#toc-enabling-syntax-in-plugins">在插件中启用其他语法</a></li></ul></li> <li><a href="#toc-building-nodes">构建节点</a></li> <li><a href="#toc-best-practices">最佳实践</a> <ul><li><a href="#toc-avoid-traversing-the-ast-as-much-as-possible">尽量避免遍历抽象语法树（AST）</a></li> <li><a href="#toc-merge-visitors-whenever-possible">及时合并访问者对象</a></li> <li><a href="#toc-do-not-traverse-when-manual-lookup-will-do">可以手动查找就不要遍历</a></li> <li><a href="#toc-optimizing-nested-visitors">优化嵌套的访问者对象</a></li> <li><a href="#toc-being-aware-of-nested-structures">留意嵌套结构</a></li> <li><a href="#toc-unit-testing">单元测试</a></li></ul></li></ul> <h1 id="介绍"><a href="#介绍" class="header-anchor">#</a> <a id="toc-introduction"></a>介绍</h1> <p>Babel 是一个通用的多功能的 JavaScript 编译器。此外它还拥有众多模块可用于不同形式的静态分析。</p> <blockquote><p>静态分析是在不需要执行代码的前提下对代码进行分析的处理过程 （执行代码的同时进行代码分析即是动态分析）。 静态分析的目的是多种多样的， 它可用于语法检查，编译，代码高亮，代码转换，优化，压缩等等场景。</p></blockquote> <p>你可以使用 Babel 创建多种类型的工具来帮助你更有效率并且写出更好的程序。</p> <blockquote><p><em><strong>在 Twitter 上关注 <a href="https://twitter.com/thejameskyle" target="_blank" rel="noopener noreferrer">@thejameskyle<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，第一时间获取更新。</strong></em></p></blockquote> <hr> <h1 id="基础"><a href="#基础" class="header-anchor">#</a> <a id="toc-basics"></a>基础</h1> <p>Babel 是 JavaScript 编译器，更确切地说是源码到源码的编译器，通常也叫做“转换编译器（transpiler）”。 意思是说你为 Babel 提供一些 JavaScript 代码，Babel 更改这些代码，然后返回给你新生成的代码。</p> <h2 id="抽象语法树-asts"><a href="#抽象语法树-asts" class="header-anchor">#</a> <a id="toc-asts"></a>抽象语法树（ASTs）</h2> <p>这个处理过程中的每一步都涉及到创建或是操作<a href="https://en.wikipedia.org/wiki/Abstract_syntax_tree" target="_blank" rel="noopener noreferrer">抽象语法树<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，亦称 AST。</p> <blockquote><p>Babel 使用一个基于 <a href="https://github.com/estree/estree" target="_blank" rel="noopener noreferrer">ESTree<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 并修改过的 AST，它的内核说明文档可以在<a href="https://github.com/babel/babel/blob/master/doc/ast/spec.md" target="_blank" rel="noopener noreferrer">这里<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>找到。</p></blockquote> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">square</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> n <span class="token operator">*</span> n<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><blockquote><p><a href="http://astexplorer.net/" target="_blank" rel="noopener noreferrer">AST Explorer<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 可以让你对 AST 节点有一个更好的感性认识。 <a href="http://astexplorer.net/#/Z1exs6BWMq" target="_blank" rel="noopener noreferrer">这里<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>是上述代码的一个示例链接。</p></blockquote> <p>这个程序可以被表示成如下的一棵树：</p> <div class="language-md line-numbers-mode"><pre class="language-md"><code><span class="token list punctuation">-</span> FunctionDeclaration:
  <span class="token list punctuation">-</span> id:
    <span class="token list punctuation">-</span> Identifier:
      <span class="token list punctuation">-</span> name: square
  <span class="token list punctuation">-</span> params [1]
    <span class="token list punctuation">-</span> Identifier
      <span class="token list punctuation">-</span> name: n
  <span class="token list punctuation">-</span> body:
    <span class="token list punctuation">-</span> BlockStatement
      <span class="token list punctuation">-</span> body [1]
        <span class="token list punctuation">-</span> ReturnStatement
          <span class="token list punctuation">-</span> argument
            <span class="token list punctuation">-</span> BinaryExpression
              <span class="token list punctuation">-</span> operator: *
              <span class="token list punctuation">-</span> left
                <span class="token list punctuation">-</span> Identifier
                  <span class="token list punctuation">-</span> name: n
              <span class="token list punctuation">-</span> right
                <span class="token list punctuation">-</span> Identifier
                  <span class="token list punctuation">-</span> name: n
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>或是如下所示的 JavaScript Object（对象）：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
  type<span class="token operator">:</span> <span class="token string">&quot;FunctionDeclaration&quot;</span><span class="token punctuation">,</span>
  id<span class="token operator">:</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> <span class="token string">&quot;Identifier&quot;</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span> <span class="token string">&quot;square&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  params<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
    type<span class="token operator">:</span> <span class="token string">&quot;Identifier&quot;</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span> <span class="token string">&quot;n&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  body<span class="token operator">:</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> <span class="token string">&quot;BlockStatement&quot;</span><span class="token punctuation">,</span>
    body<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token string">&quot;ReturnStatement&quot;</span><span class="token punctuation">,</span>
      argument<span class="token operator">:</span> <span class="token punctuation">{</span>
        type<span class="token operator">:</span> <span class="token string">&quot;BinaryExpression&quot;</span><span class="token punctuation">,</span>
        operator<span class="token operator">:</span> <span class="token string">&quot;*&quot;</span><span class="token punctuation">,</span>
        left<span class="token operator">:</span> <span class="token punctuation">{</span>
          type<span class="token operator">:</span> <span class="token string">&quot;Identifier&quot;</span><span class="token punctuation">,</span>
          name<span class="token operator">:</span> <span class="token string">&quot;n&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        right<span class="token operator">:</span> <span class="token punctuation">{</span>
          type<span class="token operator">:</span> <span class="token string">&quot;Identifier&quot;</span><span class="token punctuation">,</span>
          name<span class="token operator">:</span> <span class="token string">&quot;n&quot;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>你会留意到 AST 的每一层都拥有相同的结构：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
  type<span class="token operator">:</span> <span class="token string">&quot;FunctionDeclaration&quot;</span><span class="token punctuation">,</span>
  id<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  params<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token operator">...</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  body<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
  type<span class="token operator">:</span> <span class="token string">&quot;Identifier&quot;</span><span class="token punctuation">,</span>
  name<span class="token operator">:</span> <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
  type<span class="token operator">:</span> <span class="token string">&quot;BinaryExpression&quot;</span><span class="token punctuation">,</span>
  operator<span class="token operator">:</span> <span class="token operator">...</span><span class="token punctuation">,</span>
  left<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  right<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><blockquote><p>注意：出于简化的目的移除了某些属性</p></blockquote> <p>这样的每一层结构也被叫做 <strong>节点（Node）</strong>。 一个 AST 可以由单一的节点或是成百上千个节点构成。 它们组合在一起可以描述用于静态分析的程序语法。</p> <p>每一个节点都有如下所示的接口（Interface）：</p> <div class="language-typescript line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">interface</span> <span class="token class-name">Node</span> <span class="token punctuation">{</span>
  <span class="token keyword">type</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>字符串形式的 <code>type</code> 字段表示节点的类型（如： <code>&quot;FunctionDeclaration&quot;</code>，<code>&quot;Identifier&quot;</code>，或 <code>&quot;BinaryExpression&quot;</code>）。 每一种类型的节点定义了一些附加属性用来进一步描述该节点类型。</p> <p>Babel 还为每个节点额外生成了一些属性，<strong>用于描述该节点在原始代码中的位置</strong>。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
  type<span class="token operator">:</span> <span class="token operator">...</span><span class="token punctuation">,</span>
  start<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  end<span class="token operator">:</span> <span class="token number">38</span><span class="token punctuation">,</span>
  loc<span class="token operator">:</span> <span class="token punctuation">{</span>
    start<span class="token operator">:</span> <span class="token punctuation">{</span>
      line<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      column<span class="token operator">:</span> <span class="token number">0</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    end<span class="token operator">:</span> <span class="token punctuation">{</span>
      line<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
      column<span class="token operator">:</span> <span class="token number">1</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>每一个节点都会有 <code>start</code>，<code>end</code>，<code>loc</code> 这几个属性。</p> <h2 id="babel-的处理步骤"><a href="#babel-的处理步骤" class="header-anchor">#</a> <a id="toc-stages-of-babel"></a>Babel 的处理步骤</h2> <p>Babel 的三个主要处理步骤分别是： <strong>解析（parse）</strong>，<strong>转换（transform）</strong>，<strong>生成（generate）</strong>。</p> <h3 id="解析"><a href="#解析" class="header-anchor">#</a> <a id="toc-parse"></a>解析</h3> <p><strong>解析</strong>步骤接收代码并输出 AST。 这个步骤分为两个阶段：<a href="https://en.wikipedia.org/wiki/Lexical_analysis" target="_blank" rel="noopener noreferrer"><strong>词法分析（Lexical Analysis）</strong><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>和 <a href="https://en.wikipedia.org/wiki/Parsing" target="_blank" rel="noopener noreferrer"><strong>语法分析（Syntactic Analysis）</strong><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <h4 id="词法分析"><a href="#词法分析" class="header-anchor">#</a> <a id="toc-lexical-analysis"></a>词法分析</h4> <p>词法分析阶段把字符串形式的代码转换为 <strong>令牌（tokens）</strong> 流。</p> <p>你可以把令牌看作是一个扁平的语法片段数组：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>n <span class="token operator">*</span> n<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">[</span>
  <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> value<span class="token operator">:</span> <span class="token string">&quot;n&quot;</span><span class="token punctuation">,</span> start<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> end<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> loc<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> value<span class="token operator">:</span> <span class="token string">&quot;*&quot;</span><span class="token punctuation">,</span> start<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> end<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> loc<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> value<span class="token operator">:</span> <span class="token string">&quot;n&quot;</span><span class="token punctuation">,</span> start<span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span> end<span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span> loc<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token operator">...</span>
<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>每一个 <code>type</code> 有一组属性来描述该令牌：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
  type<span class="token operator">:</span> <span class="token punctuation">{</span>
    label<span class="token operator">:</span> <span class="token string">'name'</span><span class="token punctuation">,</span>
    keyword<span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
    beforeExpr<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    startsExpr<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    rightAssociative<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    isLoop<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    isAssign<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    prefix<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    postfix<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    binop<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    updateContext<span class="token operator">:</span> <span class="token keyword">null</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>和 AST 节点一样它们也有 <code>start</code>，<code>end</code>，<code>loc</code> 属性。.</p> <h4 id="语法分析"><a href="#语法分析" class="header-anchor">#</a> <a id="toc-syntactic-analysis"></a>语法分析</h4> <p>语法分析阶段会把一个令牌流转换成 AST 的形式。 这个阶段会使用令牌中的信息把它们转换成一个 AST 的表述结构，这样更易于后续的操作。</p> <h3 id="转换"><a href="#转换" class="header-anchor">#</a> <a id="toc-transform"></a>转换</h3> <p><a href="https://en.wikipedia.org/wiki/Program_transformation" target="_blank" rel="noopener noreferrer">转换<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>步骤接收 AST 并对其进行<strong>遍历</strong>，在此过程中对节点进行添加、更新及移除等操作。 这是 Babel 或是其他编译器中最复杂的过程，同时也是插件将要介入工作的部分，这将是本手册的主要内容， 因此让我们慢慢来。</p> <h3 id="生成"><a href="#生成" class="header-anchor">#</a> <a id="toc-generate"></a>生成</h3> <p><a href="https://en.wikipedia.org/wiki/Code_generation_(compiler)" target="_blank" rel="noopener noreferrer">代码生成<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>步骤把最终（经过一系列转换之后）的 AST 转换成字符串形式的代码，同时还会创建<a href="http://www.html5rocks.com/en/tutorials/developertools/sourcemaps/" target="_blank" rel="noopener noreferrer">源码映射（source maps）<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>代码生成其实很简单：深度优先遍历整个 AST，然后构建可以表示转换后代码的字符串。</p> <h2 id="遍历"><a href="#遍历" class="header-anchor">#</a> <a id="toc-traversal"></a>遍历</h2> <p>想要转换 AST 你需要进行递归的<a href="https://en.wikipedia.org/wiki/Tree_traversal" target="_blank" rel="noopener noreferrer">树形遍历<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>比方说我们有一个 <code>FunctionDeclaration</code> 类型。它有几个属性：<code>id</code>，<code>params</code>，和 <code>body</code>，每一个都有一些内嵌节点。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
  type<span class="token operator">:</span> <span class="token string">&quot;FunctionDeclaration&quot;</span><span class="token punctuation">,</span>
  id<span class="token operator">:</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> <span class="token string">&quot;Identifier&quot;</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span> <span class="token string">&quot;square&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  params<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
    type<span class="token operator">:</span> <span class="token string">&quot;Identifier&quot;</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span> <span class="token string">&quot;n&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  body<span class="token operator">:</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> <span class="token string">&quot;BlockStatement&quot;</span><span class="token punctuation">,</span>
    body<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token string">&quot;ReturnStatement&quot;</span><span class="token punctuation">,</span>
      argument<span class="token operator">:</span> <span class="token punctuation">{</span>
        type<span class="token operator">:</span> <span class="token string">&quot;BinaryExpression&quot;</span><span class="token punctuation">,</span>
        operator<span class="token operator">:</span> <span class="token string">&quot;*&quot;</span><span class="token punctuation">,</span>
        left<span class="token operator">:</span> <span class="token punctuation">{</span>
          type<span class="token operator">:</span> <span class="token string">&quot;Identifier&quot;</span><span class="token punctuation">,</span>
          name<span class="token operator">:</span> <span class="token string">&quot;n&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        right<span class="token operator">:</span> <span class="token punctuation">{</span>
          type<span class="token operator">:</span> <span class="token string">&quot;Identifier&quot;</span><span class="token punctuation">,</span>
          name<span class="token operator">:</span> <span class="token string">&quot;n&quot;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>于是我们从 <code>FunctionDeclaration</code> 开始并且我们知道它的内部属性（即：<code>id</code>，<code>params</code>，<code>body</code>），所以我们依次访问每一个属性及它们的子节点。</p> <p>接着我们来到 <code>id</code>，它是一个 <code>Identifier</code>。<code>Identifier</code> 没有任何子节点属性，所以我们继续。</p> <p>之后是 <code>params</code>，由于它是一个数组节点所以我们访问其中的每一个，它们都是 <code>Identifier</code> 类型的单一节点，然后我们继续。</p> <p>此时我们来到了 <code>body</code>，这是一个 <code>BlockStatement</code> 并且也有一个 <code>body</code>节点，而且也是一个数组节点，我们继续访问其中的每一个。</p> <p>这里唯一的一个属性是 <code>ReturnStatement</code> 节点，它有一个 <code>argument</code>，我们访问 <code>argument</code> 就找到了 <code>BinaryExpression</code>。</p> <p><code>BinaryExpression</code> 有一个 <code>operator</code>，一个 <code>left</code>，和一个 <code>right</code>。 Operator 不是一个节点，它只是一个值因此我们不用继续向内遍历，我们只需要访问 <code>left</code> 和 <code>right</code>。</p> <p>Babel 的转换步骤全都是这样的遍历过程。</p> <h3 id="visitors-访问者"><a href="#visitors-访问者" class="header-anchor">#</a> <a id="toc-visitors"></a>Visitors（访问者）</h3> <p>当我们谈及“进入”一个节点，实际上是说我们在<strong>访问</strong>它们，之所以使用这样的术语是因为有一个<a href="https://en.wikipedia.org/wiki/Visitor_pattern" target="_blank" rel="noopener noreferrer"><strong>访问者模式（visitor）</strong><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>的概念。</p> <p>访问者是一个用于 AST 遍历的跨语言的模式。简单的说它们就是一个对象，定义了用于在一个树状结构中获取具体节点的方法。 这么说有些抽象所以让我们来看一个例子。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> MyVisitor <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">Identifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Called!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 你也可以先创建一个访问者对象，并在稍后给它添加方法。</span>
<span class="token keyword">let</span> visitor <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
visitor<span class="token punctuation">.</span><span class="token function-variable function">MemberExpression</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
visitor<span class="token punctuation">.</span><span class="token function-variable function">FunctionDeclaration</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><blockquote><p><strong>注意</strong>： <code>Identifier() { ... }</code> 是 <code>Identifier: { enter() { ... } }</code> 的简写形式。</p></blockquote> <p>这是一个简单的访问者，把它用于遍历中时，每当在树中遇见一个 <code>Identifier</code> 的时候会调用 <code>Identifier()</code> 方法。</p> <p>所以在下面的代码中 <code>Identifier()</code> 方法会被调用四次(包括 <code>square</code> 在内，总共有四个 <code>Identifier</code>)</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">square</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> n <span class="token operator">*</span> n<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code>path<span class="token punctuation">.</span><span class="token function">traverse</span><span class="token punctuation">(</span>MyVisitor<span class="token punctuation">)</span><span class="token punctuation">;</span>
Called<span class="token operator">!</span>
Called<span class="token operator">!</span>
Called<span class="token operator">!</span>
Called<span class="token operator">!</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>这些调用都发生在<strong>进入</strong>节点时，不过有时候我们也可以在<strong>退出</strong>时调用访问者方法。.</p> <p>假设我们有一个树状结构：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token operator">-</span> FunctionDeclaration
  <span class="token operator">-</span> <span class="token function">Identifier</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span>
  <span class="token operator">-</span> <span class="token function">Identifier</span> <span class="token punctuation">(</span>params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token operator">-</span> <span class="token function">BlockStatement</span> <span class="token punctuation">(</span>body<span class="token punctuation">)</span>
    <span class="token operator">-</span> <span class="token function">ReturnStatement</span> <span class="token punctuation">(</span>body<span class="token punctuation">)</span>
      <span class="token operator">-</span> <span class="token function">BinaryExpression</span> <span class="token punctuation">(</span>argument<span class="token punctuation">)</span>
        <span class="token operator">-</span> <span class="token function">Identifier</span> <span class="token punctuation">(</span>left<span class="token punctuation">)</span>
        <span class="token operator">-</span> <span class="token function">Identifier</span> <span class="token punctuation">(</span>right<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>当我们向下遍历这颗树的每一个分支时我们最终会走到尽头，于是我们需要往上遍历回去从而获取到下一个节点。 向下遍历这棵树我们<strong>进入</strong>每个节点，向上遍历回去时我们<strong>退出</strong>每个节点。</p> <p>让我们以上面那棵树为例子走一遍这个过程。</p> <ul><li>进入 <code>FunctionDeclaration</code> <ul><li>进入 <code>Identifier (id)</code></li> <li>走到尽头</li> <li>退出 <code>Identifier (id)</code></li> <li>进入 <code>Identifier (params[0])</code></li> <li>走到尽头</li> <li>退出 <code>Identifier (params[0])</code></li> <li>进入 <code>BlockStatement (body)</code></li> <li>进入 <code>ReturnStatement (body)</code> <ul><li>进入 <code>BinaryExpression (argument)</code></li> <li>进入 <code>Identifier (left)</code> <ul><li>走到尽头</li></ul></li> <li>退出 <code>Identifier (left)</code></li> <li>进入 <code>Identifier (right)</code> <ul><li>走到尽头</li></ul></li> <li>退出 <code>Identifier (right)</code></li> <li>退出 <code>BinaryExpression (argument)</code></li></ul></li> <li>退出 <code>ReturnStatement (body)</code></li> <li>退出 <code>BlockStatement (body)</code></li></ul></li> <li>退出 <code>FunctionDeclaration</code></li></ul> <p>所以当创建访问者时你实际上有两次机会来访问一个节点。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> MyVisitor <span class="token operator">=</span> <span class="token punctuation">{</span>
  Identifier<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token function">enter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Entered!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Exited!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>如有必要，你还可以把方法名用<code>|</code>分割成<code>Idenfifier | MemberExpression</code>形式的字符串，把同一个函数应用到多种访问节点。.</p> <p>在<a href="https://github.com/babel/babel/blob/2b6ff53459d97218b0cf16f8a51c14a165db1fd2/packages/babel-plugin-transform-flow-comments/src/index.js#L47" target="_blank" rel="noopener noreferrer">flow-comments<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 插件中的例子如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> MyVisitor <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token string">&quot;ExportNamedDeclaration|Flow&quot;</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>你也可以在访问者中使用别名(如<a href="https://github.com/babel/babel/tree/master/packages/babel-types/src/definitions" target="_blank" rel="noopener noreferrer">babel-types<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>定义).</p> <p>例如，</p> <p><code>Function</code> is an alias for <code>FunctionDeclaration</code>, <code>FunctionExpression</code>, <code>ArrowFunctionExpression</code>, <code>ObjectMethod</code> and <code>ClassMethod</code>.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> MyVisitor <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">Function</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="paths-路径"><a href="#paths-路径" class="header-anchor">#</a> <a id="toc-paths"></a>Paths（路径）</h3> <p>AST 通常会有许多节点，那么节点之间如何相互关联呢？ 我们可以使用一个可操作和可访问的巨大可变对象表示节点之间的关联关系，或者也可以用<strong>Paths</strong>（路径）来简化这件事情。</p> <p><strong>Path</strong> 是表示两个节点之间连接的对象。</p> <p>例如，如果有下面这样一个节点及其子节点︰</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
  type<span class="token operator">:</span> <span class="token string">&quot;FunctionDeclaration&quot;</span><span class="token punctuation">,</span>
  id<span class="token operator">:</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> <span class="token string">&quot;Identifier&quot;</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span> <span class="token string">&quot;square&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>将子节点 <code>Identifier</code> 表示为一个路径（Path）的话，看起来是这样的：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;parent&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;FunctionDeclaration&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;id&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token operator">...</span><span class="token punctuation">.</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">&quot;node&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Identifier&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;square&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>同时它还包含关于该路径的其他元数据：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;parent&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">&quot;node&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">&quot;hub&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">&quot;contexts&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token string">&quot;data&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">&quot;shouldSkip&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token string">&quot;shouldStop&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token string">&quot;removed&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token string">&quot;state&quot;</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token string">&quot;opts&quot;</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token string">&quot;skipKeys&quot;</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token string">&quot;parentPath&quot;</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token string">&quot;context&quot;</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token string">&quot;container&quot;</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token string">&quot;listKey&quot;</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token string">&quot;inList&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token string">&quot;parentKey&quot;</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token string">&quot;key&quot;</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token string">&quot;scope&quot;</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token string">&quot;type&quot;</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token string">&quot;typeAnnotation&quot;</span><span class="token operator">:</span> <span class="token keyword">null</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>当然路径对象还包含添加、更新、移动和删除节点有关的其他很多方法，稍后我们再来看这些方法。</p> <p>在某种意义上，路径是一个节点在树中的位置以及关于该节点各种信息的响应式 (<strong>Reactive</strong>) 表示。 当你调用一个修改树的方法后，路径信息也会被更新。 Babel 帮你管理这一切，从而使得节点操作简单，尽可能做到无状态。</p> <h4 id="paths-in-visitors-存在于访问者中的路径"><a href="#paths-in-visitors-存在于访问者中的路径" class="header-anchor">#</a> <a id="toc-paths-in-visitors"></a>Paths in Visitors（存在于访问者中的路径）</h4> <p>当你有一个 <code>Identifier()</code> 成员方法的访问者时，你实际上是在访问路径而非节点。 通过这种方式，你操作的就是节点的响应式表示（译注：即路径）而非节点本身。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> MyVisitor <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">Identifier</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Visiting: &quot;</span> <span class="token operator">+</span> path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code>a <span class="token operator">+</span> b <span class="token operator">+</span> c<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code>path<span class="token punctuation">.</span><span class="token function">traverse</span><span class="token punctuation">(</span>MyVisitor<span class="token punctuation">)</span><span class="token punctuation">;</span>
Visiting<span class="token operator">:</span> a
Visiting<span class="token operator">:</span> b
Visiting<span class="token operator">:</span> c
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="state-状态"><a href="#state-状态" class="header-anchor">#</a> <a id="toc-state"></a>State（状态）</h3> <p>状态是抽象语法树AST转换的敌人，状态管理会不断牵扯你的精力，而且几乎所有你对状态的假设，总是会有一些未考虑到的语法最终证明你的假设是错误的。</p> <p>考虑下列代码：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">square</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> n <span class="token operator">*</span> n<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>让我们写一个把 <code>n</code> 重命名为 <code>x</code> 的访问者的快速实现.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> paramName<span class="token punctuation">;</span>

<span class="token keyword">const</span> MyVisitor <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">FunctionDeclaration</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> param <span class="token operator">=</span> path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    paramName <span class="token operator">=</span> param<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
    param<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;x&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token function">Identifier</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>name <span class="token operator">===</span> paramName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;x&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>对于上面的例子代码而言，这段访问者代码也许能工作，但它很容易被打破：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">square</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> n <span class="token operator">*</span> n<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
n<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>更好的处理方式是使用递归，下面让我们来像克里斯托佛·诺兰的电影盗梦空间那样来把一个访问者放进另外一个访问者里面。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> updateParamNameVisitor <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">Identifier</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token keyword">this</span><span class="token punctuation">.</span>paramName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;x&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> MyVisitor <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">FunctionDeclaration</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> param <span class="token operator">=</span> path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> paramName <span class="token operator">=</span> param<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
    param<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;x&quot;</span><span class="token punctuation">;</span>

    path<span class="token punctuation">.</span><span class="token function">traverse</span><span class="token punctuation">(</span>updateParamNameVisitor<span class="token punctuation">,</span> <span class="token punctuation">{</span> paramName <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

path<span class="token punctuation">.</span><span class="token function">traverse</span><span class="token punctuation">(</span>MyVisitor<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>当然，这只是一个刻意编写的例子，不过它演示了如何从访问者中消除全局状态。</p> <h3 id="scopes-作用域"><a href="#scopes-作用域" class="header-anchor">#</a> <a id="toc-scopes"></a>Scopes（作用域）</h3> <p>接下来让我们介绍<a href="https://en.wikipedia.org/wiki/Scope_(computer_science)" target="_blank" rel="noopener noreferrer"><strong>作用域(scope)</strong><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>的概念。 JavaScript 支持<a href="https://en.wikipedia.org/wiki/Scope_(computer_science)#Lexical_scoping_vs._dynamic_scoping" target="_blank" rel="noopener noreferrer">词法作用域<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，其是一种树状嵌套结构，代码块在树状嵌套结构创建出新的作用域。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// global scope</span>

<span class="token keyword">function</span> <span class="token function">scopeOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// scope 1</span>

  <span class="token keyword">function</span> <span class="token function">scopeTwo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// scope 2</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>在 JavaScript 中，每当你创建了一个引用，不管是通过变量（variable）、函数（function）、类型（class）、参数（params）、模块导入（import）还是标签（label）等，它都属于当前作用域。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> global <span class="token operator">=</span> <span class="token string">&quot;I am in the global scope&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">scopeOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> one <span class="token operator">=</span> <span class="token string">&quot;I am in the scope created by `scopeOne()`&quot;</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">scopeTwo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> two <span class="token operator">=</span> <span class="token string">&quot;I am in the scope created by `scopeTwo()`&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>更深的内部作用域代码可以使用外层作用域中的引用。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">scopeOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> one <span class="token operator">=</span> <span class="token string">&quot;I am in the scope created by `scopeOne()`&quot;</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">scopeTwo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    one <span class="token operator">=</span> <span class="token string">&quot;I am updating the reference in `scopeOne` inside `scopeTwo`&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>内层作用域也可以创建和外层作用域同名的引用。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">scopeOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> one <span class="token operator">=</span> <span class="token string">&quot;I am in the scope created by `scopeOne()`&quot;</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">scopeTwo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> one <span class="token operator">=</span> <span class="token string">&quot;I am creating a new `one` but leaving reference in `scopeOne()` alone.&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>当编写一个转换时，必须小心作用域。我们得确保在改变代码的各个部分时不会破坏已经存在的代码。</p> <p>我们在添加一个新的引用时需要确保新增加的引用名字和已有的所有引用不冲突。 或者我们仅仅想找出使用一个变量的所有引用， 我们只想在给定的作用域（Scope）中找出这些引用。</p> <p>作用域可以被表示为如下形式：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
  path<span class="token operator">:</span> path<span class="token punctuation">,</span>
  block<span class="token operator">:</span> path<span class="token punctuation">.</span>node<span class="token punctuation">,</span>
  parentBlock<span class="token operator">:</span> path<span class="token punctuation">.</span>parent<span class="token punctuation">,</span>
  parent<span class="token operator">:</span> parentScope<span class="token punctuation">,</span>
  bindings<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token operator">...</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>当你创建一个新的作用域时，需要给出它的路径和父作用域，之后在遍历过程中它会在该作用域内收集所有的引用(“绑定”)。</p> <p>一旦引用收集完毕，你就可以在作用域（Scopes）上使用各种方法，稍后我们会了解这些方法。</p> <h4 id="bindings-绑定"><a href="#bindings-绑定" class="header-anchor">#</a> <a id="toc-bindings"></a>Bindings（绑定）</h4> <p>所有引用属于特定的作用域，引用和作用域的这种关系被称作：<strong>绑定（binding）</strong>。.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">scopeOnce</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> ref <span class="token operator">=</span> <span class="token string">&quot;This is a binding&quot;</span><span class="token punctuation">;</span>

  ref<span class="token punctuation">;</span> <span class="token comment">// This is a reference to a binding</span>

  <span class="token keyword">function</span> <span class="token function">scopeTwo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ref<span class="token punctuation">;</span> <span class="token comment">// This is a reference to a binding from a lower scope</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>单个绑定看起来像这样︰</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
  identifier<span class="token operator">:</span> node<span class="token punctuation">,</span>
  scope<span class="token operator">:</span> scope<span class="token punctuation">,</span>
  path<span class="token operator">:</span> path<span class="token punctuation">,</span>
  kind<span class="token operator">:</span> <span class="token string">'var'</span><span class="token punctuation">,</span>

  referenced<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  references<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
  referencePaths<span class="token operator">:</span> <span class="token punctuation">[</span>path<span class="token punctuation">,</span> path<span class="token punctuation">,</span> path<span class="token punctuation">]</span><span class="token punctuation">,</span>

  constant<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  constantViolations<span class="token operator">:</span> <span class="token punctuation">[</span>path<span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>有了这些信息你就可以查找一个绑定的所有引用，并且知道这是什么类型的绑定(参数，定义等等)，查找它所属的作用域，或者拷贝它的标识符。 你甚至可以知道它是不是常量，如果不是，那么是哪个路径修改了它。</p> <p>在很多情况下，知道一个绑定是否是常量非常有用，最有用的一种情形就是代码压缩时。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">scopeOne</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> ref1 <span class="token operator">=</span> <span class="token string">&quot;This is a constant binding&quot;</span><span class="token punctuation">;</span>

  <span class="token function">becauseNothingEverChangesTheValueOf</span><span class="token punctuation">(</span>ref1<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">scopeTwo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> ref2 <span class="token operator">=</span> <span class="token string">&quot;This is *not* a constant binding&quot;</span><span class="token punctuation">;</span>
    ref2 <span class="token operator">=</span> <span class="token string">&quot;Because this changes the value&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><hr> <h1 id="api"><a href="#api" class="header-anchor">#</a> <a id="toc-api"></a>API</h1> <p>Babel 实际上是一组模块的集合。本节我们将探索一些主要的模块，解释它们是做什么的以及如何使用它们。</p> <blockquote><p>注意：本节内容不是详细的 API 文档的替代品，正式的 API 文档将很快提供出来。</p></blockquote> <h2 id="babylon"><a href="#babylon" class="header-anchor">#</a> <a id="toc-babylon"></a><a href="https://github.com/babel/babylon" target="_blank" rel="noopener noreferrer"><code>babylon</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></h2> <p>Babylon 是 Babel 的解析器。最初是 从Acorn项目fork出来的。Acorn非常快，易于使用，并且针对非标准特性(以及那些未来的标准特性) 设计了一个基于插件的架构。</p> <p>首先，让我们安装它。</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>$ <span class="token function">npm</span> <span class="token function">install</span> --save babylon
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>先从解析一个代码字符串开始：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> babylon <span class="token keyword">from</span> <span class="token string">&quot;babylon&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">function square(n) {
  return n * n;
}</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

babylon<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Node {</span>
<span class="token comment">//   type: &quot;File&quot;,</span>
<span class="token comment">//   start: 0,</span>
<span class="token comment">//   end: 38,</span>
<span class="token comment">//   loc: SourceLocation {...},</span>
<span class="token comment">//   program: Node {...},</span>
<span class="token comment">//   comments: [],</span>
<span class="token comment">//   tokens: [...]</span>
<span class="token comment">// }</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>我们还能像下面这样传递选项给 <code>parse()</code>方法：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>babylon<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  sourceType<span class="token operator">:</span> <span class="token string">&quot;module&quot;</span><span class="token punctuation">,</span> <span class="token comment">// default: &quot;script&quot;</span>
  plugins<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;jsx&quot;</span><span class="token punctuation">]</span> <span class="token comment">// default: []</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><code>sourceType</code> 可以是 <code>&quot;module&quot;</code> 或者 <code>&quot;script&quot;</code>，它表示 Babylon 应该用哪种模式来解析。 <code>&quot;module&quot;</code> 将会在严格模式下解析并且允许模块定义，<code>&quot;script&quot;</code> 则不会。</p> <blockquote><p><strong>注意：</strong> <code>sourceType</code> 的默认值是 <code>&quot;script&quot;</code> 并且在发现 <code>import</code> 或 <code>export</code> 时产生错误。 使用 <code>scourceType: &quot;module&quot;</code> 来避免这些错误。</p></blockquote> <p>由于 Babylon 使用了基于插件的架构，因此有一个 <code>plugins</code> 选项可以开关内置的插件。 注意 Babylon 尚未对外部插件开放此 API 接口，不排除未来会开放此API。</p> <p>要查看完整的插件列表，请参见 <a href="https://github.com/babel/babylon/blob/master/README.md#plugins" target="_blank" rel="noopener noreferrer">Babylon README<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>文件。.</p> <h2 id="babel-traverse"><a href="#babel-traverse" class="header-anchor">#</a> <a id="toc-babel-traverse"></a><a href="https://github.com/babel/babel/tree/master/packages/babel-traverse" target="_blank" rel="noopener noreferrer"><code>babel-traverse</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></h2> <p>Babel Traverse（遍历）模块维护了整棵树的状态，并且负责替换、移除和添加节点。</p> <p>运行以下命令安装：</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>$ <span class="token function">npm</span> <span class="token function">install</span> --save @babel/traverse
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>我们可以和 Babylon 一起使用来遍历和更新节点：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> babylon <span class="token keyword">from</span> <span class="token string">&quot;babylon&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> traverse <span class="token keyword">from</span> <span class="token string">&quot;babel-traverse&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">function square(n) {
  return n * n;
}</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

<span class="token keyword">const</span> ast <span class="token operator">=</span> babylon<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">traverse</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">enter</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&quot;Identifier&quot;</span> <span class="token operator">&amp;&amp;</span>
      path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">&quot;n&quot;</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;x&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h2 id="babel-types"><a href="#babel-types" class="header-anchor">#</a> <a id="toc-babel-types"></a><a href="https://github.com/babel/babel/tree/master/packages/babel-types" target="_blank" rel="noopener noreferrer"><code>babel-types</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></h2> <p>Babel Types模块是一个用于 AST 节点的 Lodash 式工具库（译注：Lodash 是一个 JavaScript 函数工具库，提供了基于函数式编程风格的众多工具函数）， 它包含了<strong>构造、验证以及变换</strong> AST 节点的方法。 该工具库包含考虑周到的工具方法，对编写处理AST逻辑非常有用。</p> <p>可以运行以下命令来安装它：</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>$ <span class="token function">npm</span> <span class="token function">install</span> --save @babel/types
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>然后按如下所示来使用：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> traverse <span class="token keyword">from</span> <span class="token string">&quot;babel-traverse&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> t <span class="token keyword">from</span> <span class="token string">&quot;babel-types&quot;</span><span class="token punctuation">;</span>

<span class="token function">traverse</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">enter</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">isIdentifier</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>node<span class="token punctuation">,</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">&quot;n&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;x&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="definitions-定义"><a href="#definitions-定义" class="header-anchor">#</a> <a id="toc-definitions"></a>Definitions（定义）</h3> <p>Babel Types模块拥有每一个单一类型节点的定义，包括节点包含哪些属性，什么是合法值，如何构建节点、遍历节点，以及节点的别名等信息。</p> <p>单一节点类型的定义形式如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">defineType</span><span class="token punctuation">(</span><span class="token string">&quot;BinaryExpression&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  builder<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;operator&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;left&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;right&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  fields<span class="token operator">:</span> <span class="token punctuation">{</span>
    operator<span class="token operator">:</span> <span class="token punctuation">{</span>
      validate<span class="token operator">:</span> <span class="token function">assertValueType</span><span class="token punctuation">(</span><span class="token string">&quot;string&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    left<span class="token operator">:</span> <span class="token punctuation">{</span>
      validate<span class="token operator">:</span> <span class="token function">assertNodeType</span><span class="token punctuation">(</span><span class="token string">&quot;Expression&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    right<span class="token operator">:</span> <span class="token punctuation">{</span>
      validate<span class="token operator">:</span> <span class="token function">assertNodeType</span><span class="token punctuation">(</span><span class="token string">&quot;Expression&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  visitor<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;left&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;right&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  aliases<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;Binary&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Expression&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h3 id="builders-构建器"><a href="#builders-构建器" class="header-anchor">#</a> <a id="toc-builders"></a>Builders（构建器）</h3> <p>你会注意到上面的 <code>BinaryExpression</code> 定义有一个 <code>builder</code> 字段。.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>builder<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;operator&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;left&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;right&quot;</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这是由于每一个节点类型都有构造器方法builder，按类似下面的方式使用：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>t<span class="token punctuation">.</span><span class="token function">binaryExpression</span><span class="token punctuation">(</span><span class="token string">&quot;*&quot;</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span><span class="token function">identifier</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span><span class="token function">identifier</span><span class="token punctuation">(</span><span class="token string">&quot;b&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>可以创建如下所示的 AST：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
  type<span class="token operator">:</span> <span class="token string">&quot;BinaryExpression&quot;</span><span class="token punctuation">,</span>
  operator<span class="token operator">:</span> <span class="token string">&quot;*&quot;</span><span class="token punctuation">,</span>
  left<span class="token operator">:</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> <span class="token string">&quot;Identifier&quot;</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span> <span class="token string">&quot;a&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  right<span class="token operator">:</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> <span class="token string">&quot;Identifier&quot;</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span> <span class="token string">&quot;b&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>当打印出来之后是这样的：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>a <span class="token operator">*</span> b
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>构造器还会验证自身创建的节点，并在错误使用的情形下会抛出描述性错误，这就引出了下一个方法类型。</p> <h3 id="validators-验证器"><a href="#validators-验证器" class="header-anchor">#</a> <a id="toc-validators"></a>Validators（验证器）</h3> <p><code>BinaryExpression</code> 的定义还包含了节点的字段 <code>fields</code> 信息，以及如何验证这些字段。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>fields<span class="token operator">:</span> <span class="token punctuation">{</span>
  operator<span class="token operator">:</span> <span class="token punctuation">{</span>
    validate<span class="token operator">:</span> <span class="token function">assertValueType</span><span class="token punctuation">(</span><span class="token string">&quot;string&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  left<span class="token operator">:</span> <span class="token punctuation">{</span>
    validate<span class="token operator">:</span> <span class="token function">assertNodeType</span><span class="token punctuation">(</span><span class="token string">&quot;Expression&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  right<span class="token operator">:</span> <span class="token punctuation">{</span>
    validate<span class="token operator">:</span> <span class="token function">assertNodeType</span><span class="token punctuation">(</span><span class="token string">&quot;Expression&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>可以创建两种验证方法。第一种是 <code>isX</code>。.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>t<span class="token punctuation">.</span><span class="token function">isBinaryExpression</span><span class="token punctuation">(</span>maybeBinaryExpressionNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这个测试用来确保节点是一个二进制表达式，<strong>另外你也可以传入第二个参数来确保节点包含特定的属性和值</strong>。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>t<span class="token punctuation">.</span><span class="token function">isBinaryExpression</span><span class="token punctuation">(</span>maybeBinaryExpressionNode<span class="token punctuation">,</span> <span class="token punctuation">{</span> operator<span class="token operator">:</span> <span class="token string">&quot;*&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这些方法还有一种断言式的版本，会抛出异常而不是返回 <code>true</code> 或 <code>false</code>。.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>t<span class="token punctuation">.</span><span class="token function">assertBinaryExpression</span><span class="token punctuation">(</span>maybeBinaryExpressionNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
t<span class="token punctuation">.</span><span class="token function">assertBinaryExpression</span><span class="token punctuation">(</span>maybeBinaryExpressionNode<span class="token punctuation">,</span> <span class="token punctuation">{</span> operator<span class="token operator">:</span> <span class="token string">&quot;*&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Error: Expected type &quot;BinaryExpression&quot; with option { &quot;operator&quot;: &quot;*&quot; }</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="converters-变换器"><a href="#converters-变换器" class="header-anchor">#</a> <a id="toc-converters"></a>Converters（变换器）</h3> <blockquote><p>[WIP]</p></blockquote> <h2 id="babel-generator"><a href="#babel-generator" class="header-anchor">#</a> <a id="toc-babel-generator"></a><a href="https://github.com/babel/babel/tree/master/packages/babel-generator" target="_blank" rel="noopener noreferrer"><code>babel-generator</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></h2> <p>Babel Generator模块是 Babel 的代码生成器，它读取AST并将其转换为代码和源码映射（sourcemaps）。</p> <p>运行以下命令来安装它：</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>$ <span class="token function">npm</span> <span class="token function">install</span> --save @babel/generator
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>然后按如下方式使用：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> babylon <span class="token keyword">from</span> <span class="token string">&quot;babylon&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> generate <span class="token keyword">from</span> <span class="token string">&quot;babel-generator&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">function square(n) {
  return n * n;
}</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

<span class="token keyword">const</span> ast <span class="token operator">=</span> babylon<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">generate</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// {</span>
<span class="token comment">//   code: &quot;...&quot;,</span>
<span class="token comment">//   map: &quot;...&quot;</span>
<span class="token comment">// }</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>你也可以给 <code>generate()</code> 方法传递选项。.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">generate</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  retainLines<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  compact<span class="token operator">:</span> <span class="token string">&quot;auto&quot;</span><span class="token punctuation">,</span>
  concise<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  quotes<span class="token operator">:</span> <span class="token string">&quot;double&quot;</span><span class="token punctuation">,</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h2 id="babel-template"><a href="#babel-template" class="header-anchor">#</a> <a id="toc-babel-template"></a><a href="https://github.com/babel/babel/tree/master/packages/babel-template" target="_blank" rel="noopener noreferrer"><code>babel-template</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></h2> <p>babel-template 是另一个虽然很小但却非常有用的模块。 它能让你编写字符串形式且带有占位符的代码来代替手动编码， 尤其是生成的大规模 AST的时候。 在计算机科学中，这种能力被称为<strong>准引用</strong>（quasiquotes）。</p> <p>当调用<code>template</code>函数并传入字符串作为参数时，你可以提供占位符，当使用模板时，占位符会被替换。</p> <p>你可以使用两种不同的占位符：句法占位符(比如：<code>%%name%%</code>) 或者 标识符占位符 (比如：NAME)。默认情况下，@babel/template对这两种占位符都支持，但是不能混合使用。如果需要明确使用的是哪一种占位符，可以使用<code>syntacticPlaceholders</code>选项标明。</p> <blockquote><p>syntacticPlaceholders，布尔值，如果是<code>%%name%%</code>这种形式，那么syntacticPlaceholders应为<code>true</code>,否则为<code>false</code>。</p></blockquote> <p>注意：句法标识符在 Babel 7.4.0 版本引入。如果你没有控制<code>@babel/template</code>的版本(for example, when importing it from a @babel/core@^7.0.0 peer dependency)，你必须使用标识符占位符。另一方面，句法标识符也具有一些优势：它们可以用于标识符可能是语法错误的地方（例如，代替函数体，或在导出声明中），并且它们不与大写变量冲突（例如，new URL（））。</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>$ <span class="token function">npm</span> <span class="token function">install</span> --save @babel/template
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> template <span class="token keyword">from</span> <span class="token string">&quot;babel-template&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> generate <span class="token keyword">from</span> <span class="token string">&quot;babel-generator&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> t <span class="token keyword">from</span> <span class="token string">&quot;babel-types&quot;</span><span class="token punctuation">;</span>

<span class="token comment">//标识符占位符</span>
<span class="token keyword">const</span> buildRequire <span class="token operator">=</span> <span class="token function">template</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
  var IMPORT_NAME = require(SOURCE);
</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> ast <span class="token operator">=</span> <span class="token function">buildRequire</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token constant">IMPORT_NAME</span><span class="token operator">:</span> t<span class="token punctuation">.</span><span class="token function">identifier</span><span class="token punctuation">(</span><span class="token string">&quot;myModule&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token constant">SOURCE</span><span class="token operator">:</span> t<span class="token punctuation">.</span><span class="token function">stringLiteral</span><span class="token punctuation">(</span><span class="token string">&quot;my-module&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/*
//句法占位符
const buildRequire = template(`
  var %%importName%% = require(%%source%%);
`);

const ast = buildRequire({
  importName: t.identifier(&quot;myModule&quot;),
  source: t.stringLiteral(&quot;my-module&quot;),
});
*/</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">generate</span><span class="token punctuation">(</span>ast<span class="token punctuation">)</span><span class="token punctuation">.</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>输出：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> myModule <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;my-module&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h1 id="编写你的第一个-babel-插件"><a href="#编写你的第一个-babel-插件" class="header-anchor">#</a> <a id="toc-writing-your-first-babel-plugin"></a>编写你的第一个 Babel 插件</h1> <p>现在你已经熟悉了 Babel 的所有基础知识了，让我们把这些知识和插件的 API融合在一起来编写第一个 Babel 插件吧。</p> <p>先从一个接收了当前<code>babel</code>对象作为参数的 <a href="https://github.com/babel/babel/tree/master/packages/babel-core" target="_blank" rel="noopener noreferrer"><code>function</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 开始。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">babel</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// plugin contents</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>由于你将会经常这样使用，所以直接取出 <code>babel.types</code> 会更方便：（译注：这是 ES2015 语法中的对象解构，即 Destructuring）</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> types<span class="token operator">:</span> t <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// plugin contents</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>接着返回一个对象，其 <code>visitor</code> 属性是这个插件的主要访问者。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> types<span class="token operator">:</span> t <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    visitor<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token comment">// visitor contents</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>Visitor 中的每个函数接收2个参数：<code>path</code> 和 <code>state</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> types<span class="token operator">:</span> t <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    visitor<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token function">Identifier</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function">ASTNodeTypeHere</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>让我们快速编写一个可用的插件来展示一下它是如何工作的。下面是我们的源代码：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>foo <span class="token operator">===</span> bar<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>其 AST 形式如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
  type<span class="token operator">:</span> <span class="token string">&quot;BinaryExpression&quot;</span><span class="token punctuation">,</span>
  operator<span class="token operator">:</span> <span class="token string">&quot;===&quot;</span><span class="token punctuation">,</span>
  left<span class="token operator">:</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> <span class="token string">&quot;Identifier&quot;</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span> <span class="token string">&quot;foo&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  right<span class="token operator">:</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> <span class="token string">&quot;Identifier&quot;</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span> <span class="token string">&quot;bar&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>我们从添加 <code>BinaryExpression</code> 访问者方法开始：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> types<span class="token operator">:</span> t <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    visitor<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token function">BinaryExpression</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>然后我们更确切一些，只关注哪些使用了 <code>===</code> 的 <code>BinaryExpression</code>。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>visitor<span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token function">BinaryExpression</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>operator <span class="token operator">!==</span> <span class="token string">&quot;===&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>现在我们用新的标识符来替换 <code>left</code> 属性：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">BinaryExpression</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>operator <span class="token operator">!==</span> <span class="token string">&quot;===&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>left <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">identifier</span><span class="token punctuation">(</span><span class="token string">&quot;sebmck&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>于是如果我们运行这个插件我们会得到：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>sebmck <span class="token operator">===</span> bar<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>现在只需要替换 <code>right</code> 属性了。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">BinaryExpression</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>operator <span class="token operator">!==</span> <span class="token string">&quot;===&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>left <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">identifier</span><span class="token punctuation">(</span><span class="token string">&quot;sebmck&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>right <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">identifier</span><span class="token punctuation">(</span><span class="token string">&quot;dork&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>这就是我们的最终结果了：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>sebmck <span class="token operator">===</span> dork<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>完美！我们的第一个 Babel 插件。</p> <hr> <h1 id="转换操作"><a href="#转换操作" class="header-anchor">#</a> <a id="toc-transformation-operations"></a>转换操作</h1> <h2 id="访问"><a href="#访问" class="header-anchor">#</a> <a id="toc-visiting"></a>访问</h2> <h3 id="获取子节点的path"><a href="#获取子节点的path" class="header-anchor">#</a> <a id="toc-get-the-path-of-a-sub-node"></a>获取子节点的Path</h3> <p>为了得到一个AST节点的属性值，我们一般先访问到该节点，然后利用 <code>path.node.property</code> 方法即可。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// the BinaryExpression AST node has properties: `left`, `right`, `operator`</span>
<span class="token function">BinaryExpression</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>left<span class="token punctuation">;</span>
  path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>right<span class="token punctuation">;</span>
  path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>operator<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>如果你想访问到该属性的<code>path</code>，使用path对象的<code>get</code>方法，传递该属性的字符串形式作为参数。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">BinaryExpression</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  path<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'left'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">Program</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  path<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'body.0'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="检查节点的类型"><a href="#检查节点的类型" class="header-anchor">#</a> <a id="toc-check-if-a-node-is-a-certain-type"></a>检查节点的类型</h3> <p>如果你想检查节点的类型，最好的方式是：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">BinaryExpression</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">isIdentifier</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>你同样可以对节点的属性们做浅层检查：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">BinaryExpression</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">isIdentifier</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>left<span class="token punctuation">,</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">&quot;n&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>功能上等价于：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">BinaryExpression</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>left <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>
    path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>left<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&quot;Identifier&quot;</span> <span class="token operator">&amp;&amp;</span>
    path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>left<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">&quot;n&quot;</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="检查路径-path-类型"><a href="#检查路径-path-类型" class="header-anchor">#</a> <a id="toc-check-if-a-path-is-a-certain-type"></a>检查路径（Path）类型</h3> <p>一个路径具有相同的方法检查节点的类型：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">BinaryExpression</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'left'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">&quot;n&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>就相当于：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">BinaryExpression</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">isIdentifier</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>left<span class="token punctuation">,</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">&quot;n&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="检查标识符-identifier-是否被引用"><a href="#检查标识符-identifier-是否被引用" class="header-anchor">#</a> <a id="toc-check-if-an-identifier-is-referenced"></a>检查标识符（Identifier）是否被引用</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">Identifier</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">isReferencedIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>或者：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">Identifier</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">isReferenced</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>node<span class="token punctuation">,</span> path<span class="token punctuation">.</span>parent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="找到特定的父路径"><a href="#找到特定的父路径" class="header-anchor">#</a> <a id="toc-find-a-specific-parent-path"></a>找到特定的父路径</h3> <p>有时你需要从一个路径向上遍历语法树，直到满足相应的条件。</p> <p>对于每一个父路径调用<code>callback</code>并将其<code>NodePath</code>当作参数，当<code>callback</code>返回真值时，则将其<code>NodePath</code>返回。.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>path<span class="token punctuation">.</span><span class="token function">findParent</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> path<span class="token punctuation">.</span><span class="token function">isObjectExpression</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>如果也需要遍历当前节点：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>path<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> path<span class="token punctuation">.</span><span class="token function">isObjectExpression</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>查找最接近的父函数或程序：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>path<span class="token punctuation">.</span><span class="token function">getFunctionParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>向上遍历语法树，直到找到在列表中的父节点路径</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>path<span class="token punctuation">.</span><span class="token function">getStatementParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="获取同级路径"><a href="#获取同级路径" class="header-anchor">#</a> <a id="toc-get-sibling-paths"></a>获取同级路径</h3> <p>如果一个路径是在一个 <code>Function</code>／<code>Program</code>中的列表里面，它就有同级节点。</p> <ul><li>使用<code>path.inList</code>来判断路径是否有同级节点，</li> <li>使用<code>path.getSibling(index)</code>来获得同级路径,</li> <li>使用 <code>path.key</code>获取路径所在容器的索引,</li> <li>使用 <code>path.container</code>获取路径的容器（包含所有同级节点的数组）</li> <li>使用 <code>path.listKey</code>获取容器的key</li></ul> <blockquote><p>这些API用于 <a href="https://github.com/babel/babili" target="_blank" rel="noopener noreferrer">babel-minify<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 中使用的 <a href="https://github.com/babel/babili/blob/master/packages/babel-plugin-transform-merge-sibling-variables/src/index.js" target="_blank" rel="noopener noreferrer">transform-merge-sibling-variables<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 插件。</p></blockquote> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// pathA, path.key = 0</span>
<span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// pathB, path.key = 1</span>
<span class="token keyword">var</span> c <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token comment">// pathC, path.key = 2</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> types<span class="token operator">:</span> t <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    visitor<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token function">VariableDeclaration</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// if the current path is pathA</span>
        path<span class="token punctuation">.</span>inList <span class="token comment">// true</span>
        path<span class="token punctuation">.</span>listKey <span class="token comment">// &quot;body&quot;</span>
        path<span class="token punctuation">.</span>key <span class="token comment">// 0</span>
        path<span class="token punctuation">.</span><span class="token function">getSibling</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// pathA</span>
        path<span class="token punctuation">.</span><span class="token function">getSibling</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>key <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// pathB</span>
        path<span class="token punctuation">.</span>container <span class="token comment">// [pathA, pathB, pathC]</span>
        path<span class="token punctuation">.</span><span class="token function">getPrevSibling</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// path(undefined) *</span>
        path<span class="token punctuation">.</span><span class="token function">getNextSibling</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// pathB</span>
        path<span class="token punctuation">.</span><span class="token function">getAllPrevSiblings</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// []</span>
        path<span class="token punctuation">.</span><span class="token function">getAllNextSiblings</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// [pathB, pathC]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div></div></div></div></main></div> <footer class="footer" data-v-0ff35a02><div class="footer-left-wrap" data-v-0ff35a02><ul class="contact" data-v-0ff35a02><li class="contact-item" data-v-0ff35a02><a href="https://github.com/yancqs" target="_blank" rel="noopener noreferrer" class="external" data-v-0ff35a02><span class="iconfont icon-github" data-v-0ff35a02></span></a></li><li class="contact-item" data-v-0ff35a02><a href="https://weibo.com/superYoha" target="_blank" rel="noopener noreferrer" class="external" data-v-0ff35a02><span class="iconfont icon-weibo" data-v-0ff35a02></span></a></li><li class="contact-item" data-v-0ff35a02><a href="https://www.zhihu.com/people/yoha-32-56" target="_blank" rel="noopener noreferrer" class="external" data-v-0ff35a02><span class="iconfont icon-zhihu" data-v-0ff35a02></span></a></li></ul></div> <div class="footer-right-wrap" data-v-0ff35a02><ul class="copyright" data-v-0ff35a02><li class="copyright-item" data-v-0ff35a02><a href="https://policies.google.com/privacy?hl=en-US" target="_blank" rel="noopener noreferrer" class="external" data-v-0ff35a02>
            Privacy Policy
          </a></li><li class="copyright-item" data-v-0ff35a02><a data-v-0ff35a02>MIT Licensed Copyright © 2021-present</a></li></ul></div></footer> <!----></div><div class="global-ui"><!----></div></div>
    <script src="/blog/assets/js/app.b3165492.js" defer></script><script src="/blog/assets/js/7.e383f68a.js" defer></script><script src="/blog/assets/js/16.2c89c2bd.js" defer></script><script src="/blog/assets/js/6.00881a70.js" defer></script>
  </body>
</html>
